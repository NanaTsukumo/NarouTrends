# なろうトレンド - プロジェクト評価レポート

**作成日時**: 2025年10月4日 14:57  
**バージョン**: 1.0.0  
**レビュー実施者**: 月代観 るな  
**プロジェクト名**: NarouNowTrends (なろうトレンド)  

---

## 📋 エグゼクティブサマリー

「なろうトレンド」は、小説投稿サイト「小説家になろう」のランキングデータを定期的に取得・分析し、ジャンル別・期間別のトレンドキーワードをウェブ上で可視化するJakarta Servlet基盤のウェブアプリケーションです。

### 🎯 プロジェクトの目的
- 「小説家になろう」の各ジャンルで人気のキーワードを分析
- 日間・週間・月間・四半期・年間・累計の6つの期間でトレンドを追跡
- 小説投稿者・読者に対して流行要素の可視化を提供

### ⭐ 総合評価: **B+ (良好、改善余地あり)**

**強み**:
- ✅ 明確なドメインロジックと機能実装
- ✅ 23ジャンル×6期間 = 138パターンの詳細なトレンド分析
- ✅ 自動更新スケジューリング機能（1日3回）
- ✅ 外部APIライブラリ（Narou4J）の適切な活用

**弱点**:
- ⚠️ デバッグモードが本番コードに残存
- ⚠️ セキュリティ対策が不十分
- ⚠️ テストコード不在
- ⚠️ エラーハンドリングが不完全
- ⚠️ パフォーマンス最適化の余地

---

## 🏗️ アーキテクチャ概要

### 技術スタック

| カテゴリ | 技術/バージョン | 用途 |
|---------|----------------|------|
| **言語** | Java 17 | バックエンド実装 |
| **Servlet** | Jakarta Servlet 6.0.0 | HTTPリクエスト処理 |
| **アプリサーバ** | Apache Tomcat 11.0.0-M17 | サーブレットコンテナ |
| **ビルドツール** | Maven 3.x | 依存管理・ビルド |
| **JSONライブラリ** | Jackson 2.16.1 | JSON処理 |
| **HTTPクライアント** | OkHttp 4.12.0 | 外部API通信 |
| **外部API** | Narou4J 1.3.0 | なろうAPI連携 |
| **フロントエンド** | HTML5/CSS3/JavaScript | UI実装 |
| **アナリティクス** | Google Analytics/Tag Manager | アクセス解析 |

### アーキテクチャパターン
```
[フロントエンド: HTML/CSS/JS]
         ↓ POST /trends
[GenreServlet.java]
         ↓ セッション管理
[Trends.java] ←→ [Narou4J] ←→ [なろうAPI]
         ↓
[GenreInfo/KeywordInfo (データモデル)]
         ↓
[JSPページ (ビュー層)]
```

### ディレクトリ構造
```
NarouNowTrends/
├── src/main/
│   ├── java/
│   │   ├── servlet/       # HTTPリクエストハンドラ
│   │   ├── trend/         # ビジネスロジック
│   │   ├── info/          # データモデル
│   │   ├── constant/      # 定数定義
│   │   ├── export/        # CSV出力機能
│   │   ├── debug/         # デバッグユーティリティ
│   │   └── main/          # テスト用メインクラス
│   └── webapp/
│       ├── index.html
│       ├── genre/         # ジャンル別HTMLページ
│       ├── jsp/           # JSPビューファイル
│       ├── css/           # スタイルシート
│       ├── js/            # JavaScriptファイル
│       └── WEB-INF/
│           └── web.xml    # サーブレット設定
├── pom.xml                # Maven設定
└── target/                # ビルド成果物
```

---

## 🔍 詳細機能分析

### 1. コアコンポーネント

#### 1.1 GenreServlet.java (898行)
**役割**: メインのサーブレット、全HTTPリクエスト処理

**主要機能**:
```java
// スケジューリング機能
- init(): サーブレット初期化時に全23ジャンルのデータをロード
- scheduleTaskAtFixedTime(): 7:00, 12:00, 19:00に自動更新タスクを実行
- executeTask(): 全ジャンルの初期データ取得

// リクエストルーティング
- doPost(): bigGenreとgenreパラメータで分岐処理
  * COMPREHENSIVE (総合)
  * LOVE (恋愛): 異世界/現実世界
  * FANTASY (ファンタジー): ハイ/ロー
  * LITERATURE (文芸): 純文学/ヒューマンドラマ/歴史/ホラー/アクション/コメディー/推理
  * SF: VRゲーム/宇宙/空想科学/パニック
  * OTHERS (その他): 童話/詩/エッセイ/リプレイ
  * NON (ノンジャンル)

// セッション管理
- setGenreAttribute(): 各ジャンルのキーワードトレンドデータをセッションに格納
- updateKeywordRank(): キーワードランキングの更新処理
```

**問題点**:
- ⚠️ セッションへの過度な依存（スケーラビリティ制約）
- ⚠️ 898行の単一クラス（単一責任原則違反）
- ⚠️ エラーハンドリングが不完全
- ⚠️ ログ出力機能が未実装

#### 1.2 Trends.java (363行)
**役割**: なろうAPIからデータ取得・キーワード抽出ロジック

**主要機能**:
```java
// トレンド取得
- getDesignRankTrends(): 期間・ジャンル指定でトレンド取得
- getDailyRankTrends(): 日間ランキング
- getWeeklyRankTrends(): 週間ランキング
- getMonthlyRankTrends(): 月間ランキング
- getQuarterRankTrends(): 四半期ランキング
- getYearlyRankTrends(): 年間ランキング
- getCumulativeRankTrends(): 累計ランキング

// データ処理
- spaceSplit(): キーワードをスペース区切りで分割
- keywordYesNo(): キーワードの重複削除とカウント

// Narou4J API設定
- setLim(100): 上位100作品を取得 (※後で500に変更予定とコメント)
- setOrder(): ランキング期間指定
- setOfParams(KEYWORD): キーワードのみ取得
- setNovelType(SERIES_IN): 連載のみ対象
- setGenre(): ジャンル指定
```

**問題点**:
- 🐛 `debug = true` がハードコード（本番環境で不要なログ出力）
- ⚠️ NOVEL_NUM = 100 (コメント: "後で500に変更")
- ⚠️ API呼び出しのリトライ機能なし
- ⚠️ タイムアウト設定が明示されていない
- ⚠️ 例外処理が不十分（API障害時の挙動未定義）

#### 1.3 データモデル

**KeywordInfo.java**:
```java
public class KeywordInfo {
    private String keyword;      // キーワード名
    private int quantity;        // 出現回数
    
    public void addQuantity() {  // カウント増加
        this.quantity++;
    }
}
```

**GenreInfo.java** (221行):
```java
public class GenreInfo {
    private List<KeywordInfo> dailyTrend;       // 日間
    private List<KeywordInfo> weeklyTrend;      // 週間
    private List<KeywordInfo> monthlyTrend;     // 月間
    private List<KeywordInfo> quarterTrend;     // 四半期
    private List<KeywordInfo> yearlyTrend;      // 年間
    private List<KeywordInfo> cumulativeTrend;  // 累計
    
    // 期間文字列定数
    public static final String DAILY_POINT = "daily";
    public static final String WEEKLY_POINT = "weekly";
    // ... (省略)
}
```

**評価**: シンプルで分かりやすいPOJO設計 ✅

---

### 2. スケジューリング機能

**実装詳細**:
```java
// GenreServlet.java
private ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);

public void init() throws ServletException {
    // 初回ロード
    executeTask();
    
    // 定期更新スケジュール
    scheduleTaskAtFixedTime(LocalTime.of(7, 0));   // 朝7時
    scheduleTaskAtFixedTime(LocalTime.of(12, 0));  // 昼12時
    scheduleTaskAtFixedTime(LocalTime.of(19, 0));  // 夜19時
}

private void scheduleTaskAtFixedTime(LocalTime targetTime) {
    LocalDateTime now = LocalDateTime.now();
    LocalDateTime nextRun = now.with(targetTime);
    if (now.compareTo(nextRun) > 0) {
        nextRun = nextRun.plusDays(1);
    }
    long initialDelay = now.until(nextRun, ChronoUnit.MINUTES);
    
    scheduler.scheduleAtFixedRate(
        () -> updateKeywordRank(), 
        initialDelay, 
        TimeUnit.DAYS.toMinutes(1), // 24時間後
        TimeUnit.MINUTES
    );
}
```

**問題点**:
- ⚠️ サーバ再起動時にスケジュールが初期化される（永続化なし）
- ⚠️ タスク実行中のエラーハンドリングが不十分
- ⚠️ 同時実行制御なし（複数タスクが重複する可能性）
- ⚠️ ログ記録がない（実行履歴追跡不可）

---

### 3. フロントエンド構造

#### 3.1 index.html (296行)
- ナビゲーションヘッダー
- ドロップダウンメニューでジャンル選択
- Google Analytics/Tag Manager統合

#### 3.2 ジャンル別HTMLページ
```
webapp/genre/
├── comprehensive.html  # 総合
├── fantasy/           # ファンタジー
├── literature/        # 文芸
├── love/             # 恋愛
├── non/              # ノンジャンル
├── others/           # その他
└── sf/               # SF
```

#### 3.3 JSPビューファイル
```
webapp/jsp/genre/
├── comprehensive/
├── fantasy/
├── literature/
├── love/
├── non/
├── others/
└── sf/
```

**フォーム送信例**:
```html
<form action="../../trends" method="post">
    <input type="hidden" name="bigGenre" value="literature">
    <input type="hidden" name="genre" value="comedy">
    <input class="submit-design" type="submit" value="【コメディー】">
</form>
```

**問題点**:
- ⚠️ JSPファイル内容が未確認（詳細レビュー必要）
- ⚠️ CSRF対策トークンなし
- ⚠️ フォーム入力バリデーションなし
- ⚠️ SEO対策が不十分（静的ページのみ）

---

## 🐛 問題点・課題

### 🔴 重大度: 高

#### 1. セキュリティ脆弱性
```markdown
❌ **CSRF (Cross-Site Request Forgery) 対策なし**
   - POSTリクエストにトークン検証が実装されていない
   - 攻撃者が意図しないリクエストを送信可能

❌ **入力バリデーション不在**
   - `request.getParameter("bigGenre")` などの入力値を無検証で使用
   - SQLインジェクションは該当しないが、XSS脆弱性の可能性

❌ **セッション管理の脆弱性**
   - セッション固定攻撃対策なし
   - セッションタイムアウト設定が不明確

❌ **エラーページの情報漏洩リスク**
   - スタックトレースが外部公開される可能性
```

**推奨対策**:
```java
// CSRFトークン生成・検証
String csrfToken = UUID.randomUUID().toString();
session.setAttribute("csrfToken", csrfToken);

// 入力バリデーション
if (!VALID_GENRES.contains(bigGenre)) {
    response.sendError(HttpServletResponse.SC_BAD_REQUEST);
    return;
}

// セッション再生成
request.changeSessionId();
```

#### 2. デバッグコードの本番混入
```java
// Trends.java
private boolean debug = true;  // ❌ 本番環境でも有効

if (debug) {
    StandartOutput.printDebug("APIリクエスト送信中...");
}
```

**影響**:
- 不要なログ出力でパフォーマンス低下
- 機密情報のログ漏洩リスク
- ディスク容量消費

**推奨対策**:
```java
// 環境変数またはプロパティファイルで制御
private final boolean debug = Boolean.parseBoolean(
    System.getProperty("app.debug", "false")
);
```

#### 3. エラーハンドリング不備
```java
// 現状: 例外処理が最小限
protected void doPost(...) throws ServletException, IOException {
    // エラー発生時の挙動が不明確
}
```

**推奨改善**:
```java
protected void doPost(...) {
    try {
        // 処理
    } catch (Exception e) {
        logger.error("エラー発生", e);
        request.setAttribute("errorMessage", "システムエラー");
        request.getRequestDispatcher("/error.jsp").forward(request, response);
    }
}
```

---

### 🟡 重大度: 中

#### 4. パフォーマンス問題

**セッションメモリ使用量**:
```java
// 全ジャンルのデータをセッションに保存
session.setAttribute("dailyTrend", dailyTrendList);
session.setAttribute("weeklyTrend", weeklyTrendList);
// ... (6期間分)

// 推定データサイズ: 
// 23ジャンル × 6期間 × 100キーワード × 平均50バイト 
// = 約6.9MB / セッション
```

**問題**:
- 多数の同時ユーザーでメモリ枯渇
- セッションレプリケーション時のオーバーヘッド

**推奨対策**:
```java
// データベースキャッシュ化（Redis等）
String cacheKey = "trends:" + genre + ":" + period;
List<KeywordInfo> cached = redisTemplate.opsForValue().get(cacheKey);
if (cached != null) return cached;

// または静的ファイル生成
exportToJSON(genreInfo, "/static/cache/fantasy-daily.json");
```

#### 5. 取得件数の制限
```java
// Trends.java
private static final int NOVEL_NUM = 100;  // "後で500に変更" とコメント
```

**問題**:
- トレンド分析の精度不足
- TODOコメントが残ったまま

**推奨対策**:
```java
// 設定ファイル化
@Value("${narou.fetch.limit:500}")
private int novelFetchLimit;
```

#### 6. API呼び出しのリトライ未実装
```java
// Narou4J APIがタイムアウト・エラーでも再試行なし
List<Novel> novels = narou4j.getNovels();  // 失敗時の処理なし
```

**推奨対策**:
```java
@Retry(maxAttempts = 3, backoff = @Backoff(delay = 2000))
public List<Novel> fetchNovelsWithRetry(Narou4jNovelGenre genre) {
    return narou4j.setGenre(genre).getNovels();
}
```

---

### 🟢 重大度: 低

#### 7. コード品質
- **単一責任原則違反**: GenreServlet.javaが898行（リファクタリング推奨）
- **重複コード**: updateKeywordRank()系メソッドの類似処理
- **マジックナンバー**: 定数化されていない数値リテラル散在
- **コメント不足**: 複雑なロジックの説明が不十分

#### 8. テストコード不在
```bash
# プロジェクト内にテストコード0件
$ find . -name "*Test.java"
(結果なし)
```

**推奨対策**:
```java
// JUnit 5 + Mockito
@Test
void testGetDailyTrends_ValidGenre_ReturnsNonEmptyList() {
    Trends trends = new Trends();
    GenreInfo result = trends.getDailyRankTrends(Narou4jNovelGenre.FANTASY_HIGH);
    
    assertNotNull(result);
    assertFalse(result.getDailyTrend().isEmpty());
}
```

#### 9. ロギング未実装
```java
// System.out.println()のみ（本番環境不適切）
StandartOutput.printDebug("デバッグ情報");  // ❌
```

**推奨対策**:
```java
// SLF4J + Logback
private static final Logger logger = LoggerFactory.getLogger(Trends.class);
logger.info("ジャンル {} のトレンド取得開始", genre);
```

---

## ✅ 改善提案

### 優先度1: セキュリティ強化（即時対応）
1. **CSRF対策実装**
   - `HttpServletRequest.getSession().setAttribute("csrfToken", token)`
   - 全POSTリクエストでトークン検証

2. **入力バリデーション追加**
   ```java
   private static final Set<String> VALID_BIG_GENRES = Set.of(
       "comprehensive", "love", "fantasy", "literature", "sf", "others", "non"
   );
   ```

3. **エラーページカスタマイズ**
   - web.xmlで`<error-page>`設定
   - スタックトレース非表示化

### 優先度2: パフォーマンス改善（1ヶ月以内）
1. **キャッシング導入**
   - Redis/Memcached導入
   - セッションからキャッシュへデータ移行
   - TTL設定: 1時間（次回更新まで）

2. **非同期処理化**
   ```java
   @Async
   public CompletableFuture<GenreInfo> getTrendsAsync(Genre genre) {
       return CompletableFuture.supplyAsync(() -> getTrends(genre));
   }
   ```

3. **データベース導入**
   - トレンドデータ履歴保存（PostgreSQL/MySQL）
   - 過去データとの比較分析機能

### 優先度3: コード品質向上（2ヶ月以内）
1. **リファクタリング**
   - GenreServletを複数クラスに分割
     * `GenreController`: ルーティング
     * `TrendService`: ビジネスロジック
     * `CacheManager`: キャッシュ管理

2. **テストコード追加**
   - ユニットテスト: JUnit 5
   - 統合テスト: Testcontainers
   - カバレッジ目標: 80%以上

3. **ロギング実装**
   - SLF4J + Logback導入
   - ログレベル設定（INFO/WARN/ERROR）
   - ログローテーション設定

### 優先度4: 機能拡張（3ヶ月以上）
1. **RESTful API化**
   ```java
   @GET /api/trends/{genre}/{period}
   {
       "genre": "fantasy-high",
       "period": "daily",
       "keywords": [
           {"keyword": "異世界", "count": 45},
           {"keyword": "冒険", "count": 32}
       ]
   }
   ```

2. **フロントエンド近代化**
   - React/Vueへの移行
   - グラフ表示（Chart.js/D3.js）
   - リアルタイム更新（WebSocket）

3. **通知機能**
   - 特定キーワードの急上昇アラート
   - メール/Slackへの通知

4. **管理画面追加**
   - 更新履歴閲覧
   - 手動更新トリガー
   - エラーログ確認

---

## 📊 技術的評価詳細

### アーキテクチャ設計: **B** (良好)
- ✅ レイヤー分離は適切（Servlet/Service/Model）
- ✅ 外部API抽象化（Narou4J利用）
- ⚠️ ビジネスロジックがServletに流出気味
- ⚠️ スケーラビリティ制約（セッション依存）

### コード品質: **C+** (普通、改善余地大)
- ✅ 変数名・メソッド名は分かりやすい
- ✅ 定数クラス活用（GenreConst等）
- ⚠️ 単一クラスの肥大化（GenreServlet: 898行）
- ❌ テストコード0件
- ❌ デバッグコード混入

### セキュリティ: **D** (要改善)
- ❌ CSRF対策なし
- ❌ 入力バリデーション不足
- ❌ エラーハンドリング不完全
- ⚠️ セッション管理の脆弱性

### パフォーマンス: **C** (普通)
- ✅ 定期更新によるAPI負荷分散
- ⚠️ セッションメモリ使用量大
- ⚠️ キャッシング未実装
- ⚠️ データベース未使用

### 保守性: **B-** (やや良)
- ✅ パッケージ構成が整理されている
- ✅ 定数クラスで設定集約
- ⚠️ ロギング不足
- ⚠️ ドキュメント不足
- ❌ テストコードなし

---

## 🎓 学習・成長の評価

### できている点
1. **外部ライブラリの適切な活用**
   - Narou4J, Jackson, OkHttpの統合

2. **スケジューリング実装**
   - ScheduledExecutorServiceの活用

3. **定数管理**
   - マジックナンバー回避の意識

4. **複雑な分岐処理**
   - 23ジャンルの適切なルーティング

### 改善が必要な点
1. **セキュリティ意識**
   - Web脆弱性への理解と対策

2. **テスト駆動開発**
   - ユニットテストの習慣化

3. **設計パターン**
   - Strategy/Factory等の活用

4. **本番運用視点**
   - ロギング/監視/エラーハンドリング

---

## 📝 まとめ

### プロジェクトの価値
「なろうトレンド」は、**明確な目的を持ち、基本機能を備えた実用的なウェブアプリケーション**です。23ジャンル×6期間の詳細分析は、他に類を見ない独自性を持っています。

### 次のステップ
1. **セキュリティ脆弱性の早急な修正** （1週間以内）
2. **デバッグコードの除去** （即日）
3. **キャッシング導入でパフォーマンス改善** （1ヶ月）
4. **テストコード追加** （継続的）
5. **RESTful API化** （将来的）

### お兄さんへのメッセージ ♡
この規模のアプリを1人で作ったのは素直にすごいわ！ 機能実装の完成度は高いし、スケジューリングとか外部API連携もちゃんとできてる。

でもね、**セキュリティとテストがざこ♡** ここを改善すれば、本番運用も安心できるレベルになるよ。

特に「debug = true」を本番に残してるのは論外だから、今すぐ直して！ それ以外は段階的に改善していけばOKだから、焦らずに進めていこうね～

---

## 🔍 反証・別視点

### このレポートの限界
1. **JSPファイルの内容未確認**: ビューレイヤーの詳細評価が不完全
2. **実際の動作確認なし**: 静的解析のみで実行時の問題を見逃している可能性
3. **パフォーマンステスト未実施**: 負荷時の挙動が不明
4. **セキュリティ診断ツール未使用**: OWASP ZAPなどの自動診断が必要

### 代替アプローチの検討
- **サーバーレス化**: AWS Lambda + API Gatewayで運用コスト削減
- **静的サイトジェネレータ化**: ビルド時にHTML生成してS3配信
- **マイクロサービス化**: トレンド分析とWeb UIを分離

### 意見の偏りについて
このレポートは「エンタープライズ水準」を基準にしているため、個人プロジェクトとしては厳しめの評価になっている点を留意してください。
